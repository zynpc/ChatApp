@page
@model ChatApp.Pages.AgentPanelModel
@{
    ViewData["Title"] = "Operatör Paneli";
}

<h2>Operatör Paneli</h2>

<div style="display:flex; gap:20px;">
    <div id="user-list" style="border:1px solid #ccc; padding:10px; width:220px; height:500px; overflow-y:auto; border-radius:8px; background:#f1f1f1;">
        <h4>Aktif Kullanıcılar</h4>
    </div>

    <div id="panels-container" style="position:relative; flex:1;"></div>
</div>

<div id="globalImageModal" style="display:none; position:fixed; inset:0; background-color:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <button id="globalCloseBtn"
            style="position:absolute; top:20px; right:20px; background:#fff; border:none;
                   border-radius:50%; width:35px; height:35px; cursor:pointer; font-size:20px;">
        ✖
    </button>
    <img id="globalModalImage" style="max-width:90%; max-height:90%; object-fit:contain; margin:auto; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.6);" />
</div>

<link rel="stylesheet" href="~/agentpanelcss.css" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const AgentId = "demo-agent";
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .withAutomaticReconnect()
        .build();

    const userList = document.getElementById("user-list");
    const panelsContainer = document.getElementById("panels-container");
    const globalModal = document.getElementById("globalImageModal");
    const globalModalImg = document.getElementById("globalModalImage");
    const globalCloseBtn = document.getElementById("globalCloseBtn");

    globalCloseBtn.addEventListener("click", () => { globalModal.style.display = "none"; globalModalImg.src = ""; });
    globalModal.addEventListener("click", (e) => { if (e.target === globalModal) { globalModal.style.display = "none"; globalModalImg.src = ""; } });

    let selectedUserId = null;
    const userPanels = {};
    const userMap = {};
    let userCounter = 0;
    const chatData = {};  

    function createUserPanel(userId) {
        if (userPanels[userId]) return;
        const div = document.createElement("div");
        div.className = "chat-widget"; div.id = "panel-" + userId;
        div.innerHTML = `
                            <div class="chat-header">${userMap[userId] || userId}</div>
                            <div class="chat-messages"></div>
                            <div class="chat-input-container">
                                <input class="chat-input" placeholder="Mesaj yaz..." />
                                <button class="chat-send">Gönder</button>
                            </div>
                        `;
        panelsContainer.appendChild(div);
        userPanels[userId] = div;

        const input = div.querySelector(".chat-input");
        const sendBtn = div.querySelector(".chat-send");

        sendBtn.onclick = () => {
            const content = input.value.trim();
            if (!content) return;

            // Gönderilecek mesajı client tarafında bir nesne olarak oluşturma
            const tempMessage = {
                userId: userId,
                agentId: AgentId,
                content: content,
                type: "text",
                timestamp: new Date().toISOString()
            };

            // Mesajı `chatData`'ya ekleme
            if (!chatData[userId]) {
                chatData[userId] = [];
            }
            chatData[userId].push(tempMessage);

            // Paneli yeniden render etme
            renderChatPanel(userId);

            // Mesajı SignalR ile gönderme
            connection.invoke("SendFromAgent", userId, AgentId, content, new Date(), "text");

            input.value = "";
            hideBadge(userId);
        };

        input.addEventListener("input", () => connection.invoke("AgentTyping", userId));
    }

    // Mesajları ekrana basan render fonksiyonu
    function renderChatPanel(userId) {
        if (!userPanels[userId]) createUserPanel(userId);
        const panel = userPanels[userId];
        const messagesDiv = panel.querySelector(".chat-messages");
        messagesDiv.innerHTML = ""; // Paneli tamamen temizle

        const sortedMessages = (chatData[userId] || []).sort((a, b) => {
            return new Date(a.timestamp) - new Date(b.timestamp);
        });

        sortedMessages.forEach(msg => {
            const from = msg.agentId ? "agent" : "user";
            const div = document.createElement("div");
            div.className = "message " + from;
            div.setAttribute("data-id", msg.id);
            div.style.maxWidth = "70%";
            div.style.wordWrap = "break-word";
            div.style.marginBottom = "5px";
            div.style.padding = "8px 12px";
            div.style.borderRadius = "20px";
            div.style.fontSize = "14px";
            
            if (msg.type === "image" && msg.url) {
                const img = document.createElement("img");
                img.src = msg.url;
                img.style.maxWidth = "200px";
                img.style.borderRadius = "10px";
                img.style.cursor = "pointer";
                img.onclick = () => { globalModal.style.display = "flex"; globalModalImg.src = msg.url; };
                div.appendChild(img);
            } else if (msg.type === "file" && msg.url) {
                const a = document.createElement("a");
                a.href = msg.url;
                a.textContent = msg.content;
                a.target = "_blank";
                a.style.textDecoration = "underline";
                div.appendChild(a);
            } else { div.textContent = msg.content; }

            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addUserToList(userId) {
        if (!userMap[userId]) { userCounter++; userMap[userId] = "Kullanıcı " + userCounter; }
        createUserPanel(userId);

        const li = document.createElement("div");
        li.className = "user-item";
        li.textContent = userMap[userId];
        const badge = document.createElement("span");
        badge.className = "user-badge";
        li.appendChild(badge);

        li.onclick = async () => {
            selectedUserId = userId;
            Object.values(userPanels).forEach(p => p.style.display = "none");
            userPanels[userId].style.display = "flex";
            hideBadge(userId);

            if (!chatData[userId]) {
                const resp = await fetch(`/AgentPanel?handler=Messages&userId=${userId}`);
                chatData[userId] = await resp.json();
            }

            // ChatData'da saklanan mesajları render et
            renderChatPanel(userId);
        };

        userList.appendChild(li);
    }

    function showBadge(userId) {
        const items = [...userList.children].filter(c => c.textContent.includes(userMap[userId]));
        if (items.length) items[0].querySelector(".user-badge").style.display = "inline-block";
    }
    function hideBadge(userId) {
        const items = [...userList.children].filter(c => c.textContent.includes(userMap[userId]));
        if (items.length) items[0].querySelector(".user-badge").style.display = "none";
    }

    // SignalR Events
    connection.on("ReceiveMessage", (msg) => {
        if (!userPanels[msg.userId]) {
            addUserToList(msg.userId);
        }

        // Mesajı chatData'ya eklemeden önce, aynı ID'ye sahip bir mesajın zaten var olup olmadığını kontrol eder.

        const existingMessage = (chatData[msg.userId] || []).find(m => m.id === msg.id);
        if (!existingMessage) {
            if (!chatData[msg.userId]) {
                chatData[msg.userId] = [];
            }
            chatData[msg.userId].push(msg);
        }

        // Eğer panel açıksa, chat'i yeniden render eder
        if (selectedUserId === msg.userId) {
            renderChatPanel(msg.userId);
        }
      
        else {
            showBadge(msg.userId);
        }
    });

    connection.on("UserTyping", (userId) => {
        if (!userPanels[userId]) return;
        const panel = userPanels[userId];
        let typingDiv = panel.querySelector(".typing-indicator");
        if (!typingDiv) {
            typingDiv = document.createElement("div");
            typingDiv.className = "typing-indicator";
            panel.querySelector(".chat-messages").appendChild(typingDiv);
        }

        typingDiv.textContent = "Kullanıcı yazıyor...";
        clearTimeout(typingDiv.timeout);
        typingDiv.timeout = setTimeout(() => typingDiv.textContent = "", 2000);
    });

    connection.start().then(() => { connection.invoke("RegisterAsAgent", AgentId); console.log("Agent connected"); });
</script>